<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>電光掲示板GIF生成</title>
<style>
    body {
        font-family: Arial, sans-serif;
        background-color: #222;
        color: white;
        padding: 20px;
    }
    #inputArea {
        margin-bottom: 15px;
    }
    input {
        width: 300px;
        padding: 5px;
        font-size: 14px;
    }
    canvas {
        background-color: black;
        display: block;
        margin-top: 10px;
    }
    #progressBar {
        width: 100%;
        background-color: #444;
        height: 20px;
        margin-top: 10px;
        border-radius: 5px;
        overflow: hidden;
    }
    #progressFill {
        height: 100%;
        width: 0%;
        background-color: #0f0;
        transition: width 0.2s;
    }
</style>
<!-- GIF生成ライブラリを読み込むための正しいタグ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.js"></script>
<!-- ドット風フォントを読み込むための正しいタグ -->
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
</head>
<body>
    <h1>電光掲示板GIF生成</h1>
    <div id="inputArea">
        <input type="text" id="textInput" maxlength="100" placeholder="テロップ文字を入力">
        <button onclick="generateGIF()">GIF作成</button>
    </div>
    <canvas id="tickerCanvas" width="600" height="20"></canvas>
    <div id="status"></div>
    <div id="progressBar"><div id="progressFill"></div></div>
    <div id="result"></div>

<script>
async function generateGIF() {
    const text = document.getElementById('textInput').value.trim();
    if (text === '') {
        alert('文字を入力してください');
        return;
    }

    document.getElementById('status').textContent = "GIF生成中...しばらくお待ちください";

    // フォントが読み込まれるのを待機
    await document.fonts.ready;

    const canvas = document.getElementById('tickerCanvas');
    const ctx = canvas.getContext('2d');
    const width = canvas.width;
    const height = canvas.height;

    // スタイルを適用
    ctx.font = "18px 'Press Start 2P', monospace";
    ctx.textBaseline = "middle";

    const textWidth = ctx.measureText(text).width;
    
    // GIFライブラリのインスタンスを作成
    const gif = new GIF({
        workers: 2,
        quality: 10,
        width: width,
        height: height
    });

    const step = 4;
    const delay = 60;
    const totalFrames = Math.ceil((width + textWidth) / step);
    const progressFill = document.getElementById('progressFill');

    for (let i = 0; i < totalFrames; i++) {
        ctx.fillStyle = "black";
        ctx.fillRect(0, 0, width, height);
        ctx.fillStyle = "#0f0";
        ctx.fillText(text, width - i * step, height / 2);
        gif.addFrame(ctx, {copy: true, delay: delay});

        progressFill.style.width = Math.floor((i / totalFrames) * 100) + "%";
    }

    gif.on('finished', function(blob) {
        const url = URL.createObjectURL(blob);
        document.getElementById('status').textContent = "";
        progressFill.style.width = "100%";
        document.getElementById('result').innerHTML = `
            <h3>生成されたGIF:</h3>
            <img src="${url}" alt="Generated GIF"><br>
            <a href="${url}" download="ticker.gif">GIFをダウンロード</a>
        `;
    });

    gif.render();
}
</script>
</body>
</html>